#!/bin/bash
# =============================================================================
# MQTT Live - AstraIPS Inline IPS System
# Comprehensive IPS with AI Decision Engine, Device Profiler, and System Monitor
# =============================================================================

set -e

# Get script directory (works with symlinks) - AUTO-DETECT PROJECT_DIR
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PROJECT_DIR="$SCRIPT_DIR"
export MQTTLIVE_DIR="$SCRIPT_DIR"
export CONFIG_DIR="$SCRIPT_DIR/config"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Function to get all available interfaces
get_available_interfaces() {
    ip link show | grep -E "^[0-9]+:" | awk -F': ' '{print $2}' | awk '{print $1}'
}

# Function to check if interface exists
interface_exists() {
    local iface="$1"
    ip link show "$iface" >/dev/null 2>&1
}

# Function to get interface IP
get_interface_ip() {
    local iface="$1"
    ip addr show "$iface" 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d'/' -f1
}

# Function to show available interfaces
show_available_interfaces() {
    echo "üîç Available interfaces:"
    local count=1
    
    while IFS= read -r iface; do
        if [ -n "$iface" ]; then
            local ip=$(get_interface_ip "$iface")
            if [ "$iface" = "lo" ]; then
                echo "  $count) $iface (127.0.0.1) - Loopback"
            elif [ -n "$ip" ]; then
                echo "  $count) $iface ($ip) - Network Interface"
            else
                echo "  $count) $iface - Network Interface"
            fi
            ((count++))
        fi
    done < <(get_available_interfaces)
    
    echo ""
    return $count
}

# Find ethernet interface - ONLY eth* interfaces, no fallback
find_eth_interface() {
    local interfaces=$(ip link show 2>/dev/null | grep -E "^[0-9]+:" | awk -F': ' '{print $2}' | cut -d'@' -f1)
    
    # First: look for eth* interface that is UP
    for iface in $interfaces; do
        if echo "$iface" | grep -qE "^eth[0-9]+" && \
           ip link show "$iface" 2>/dev/null | grep -q "state UP"; then
            echo "$iface"
            return 0
        fi
    done
    
    # Second: look for any eth* interface (even if DOWN)
    for iface in $interfaces; do
        if echo "$iface" | grep -qE "^eth[0-9]+"; then
            echo "$iface"
            return 0
        fi
    done
    
    # No eth interface found - return failure (caller will wait)
    return 1
}

# Default values
INTERFACE=""
VERBOSE=false
SHOW_HELP=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            SHOW_HELP=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --list-interfaces)
            show_available_interfaces
            exit 0
            ;;
        -*)
            echo -e "${RED}‚ùå Unknown option: $1${NC}"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
        *)
            shift
            ;;
    esac
done

# Show help
if [ "$SHOW_HELP" = true ]; then
    echo -e "${BLUE}üõ°Ô∏è  AstraIPS - MQTT Live IPS System${NC}"
    echo "======================================"
    echo ""
    echo "USAGE:"
    echo "  sudo ./mqttlive [options]"
    echo ""
    echo "OPTIONS:"
    echo "  -h, --help             Show this help message"
    echo "  -v, --verbose          Verbose output"
    echo "  --list-interfaces      List available interfaces and exit"
    echo ""
    echo "The system automatically detects eth0/eth1 interfaces."
    echo "If no eth interface is found, it will wait until one is connected."
    echo ""
    exit 0
fi

echo -e "${BLUE}"
echo "=============================================="
echo "   üõ°Ô∏è  AstraIPS - AI-Driven Inline IPS"
echo "=============================================="
echo -e "${NC}"
echo -e "${CYAN}Project Directory: $PROJECT_DIR${NC}"
echo ""

# -----------------------------------------------------------------------------
# Find eth interface - wait until detected
# -----------------------------------------------------------------------------
echo -e "${CYAN}üîç Looking for eth interface...${NC}"

INTERFACE=$(find_eth_interface)
if [ -z "$INTERFACE" ]; then
    echo ""
    echo -e "${YELLOW}‚è≥ No eth interface detected.${NC}"
    echo -e "${YELLOW}   Waiting for eth0/eth1 to appear...${NC}"
    echo -e "${YELLOW}   (Connect an ethernet cable or USB ethernet adapter)${NC}"
    echo ""
    
    WAIT_COUNT=0
    while true; do
        INTERFACE=$(find_eth_interface)
        if [ -n "$INTERFACE" ]; then
            echo ""
            echo -e "${GREEN}‚úÖ Interface detected: $INTERFACE${NC}"
            break
        fi
        
        # Show waiting indicator every 5 seconds
        WAIT_COUNT=$((WAIT_COUNT + 1))
        if [ $((WAIT_COUNT % 5)) -eq 0 ]; then
            echo -ne "\r   ‚è≥ Still waiting... (${WAIT_COUNT}s)   "
        fi
        sleep 1
    done
fi

INTERFACE_IP=$(get_interface_ip "$INTERFACE")

echo -e "${GREEN}üì° Interface: $INTERFACE${NC}"
echo -e "${GREEN}üåê IP Address: ${INTERFACE_IP:-No IP assigned}${NC}"
echo ""

# -----------------------------------------------------------------------------
# Setup directories and session
# -----------------------------------------------------------------------------
SESSION_DIR="$PROJECT_DIR/logs"
mkdir -p "$SESSION_DIR"/{exports,pcap,scans,logs}

# Fix permissions - make everything accessible
chmod -R 777 "$SESSION_DIR" 2>/dev/null || sudo chmod -R 777 "$SESSION_DIR" 2>/dev/null || true
if [ -n "$SUDO_USER" ]; then
    sudo chown -R "$SUDO_USER:$SUDO_USER" "$SESSION_DIR" 2>/dev/null || true
fi

export SESSION_LOG_DIR="$SESSION_DIR"

echo -e "${CYAN}üìÅ Log directory: $SESSION_LOG_DIR${NC}"
echo -e "${CYAN}   üìä Database: $SESSION_LOG_DIR/session.db${NC}"
echo -e "${CYAN}   üì¶ PCAP: $SESSION_LOG_DIR/pcap/${NC}"
echo -e "${CYAN}   üìà Exports: $SESSION_LOG_DIR/exports/${NC}"
echo ""

# -----------------------------------------------------------------------------
# Check for required files
# -----------------------------------------------------------------------------
SCRIPTS_DIR="$PROJECT_DIR/scripts"
ML_DIR="$PROJECT_DIR/ml-models"
CONFIG_DIR="$PROJECT_DIR/config"

# Check Python scripts
if [ ! -f "$SCRIPTS_DIR/snort_mqtt_enhanced.py" ]; then
    echo -e "${RED}‚ùå Error: Python script not found: $SCRIPTS_DIR/snort_mqtt_enhanced.py${NC}"
    exit 1
fi

# Check config
if [ ! -f "$CONFIG_DIR/mqtt_final.lua" ]; then
    echo -e "${RED}‚ùå Error: Config file not found: $CONFIG_DIR/mqtt_final.lua${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Scripts directory: $SCRIPTS_DIR${NC}"
echo -e "${GREEN}‚úÖ Config directory: $CONFIG_DIR${NC}"
echo -e "${GREEN}‚úÖ ML Models directory: $ML_DIR${NC}"
echo ""

# -----------------------------------------------------------------------------
# Check for Snort
# -----------------------------------------------------------------------------
SNORT_BIN=$(which snort 2>/dev/null || echo "")

if [ -z "$SNORT_BIN" ]; then
    for path in /usr/local/bin/snort /usr/bin/snort "$PROJECT_DIR/snort-install/bin/snort"; do
        if [ -x "$path" ]; then
            SNORT_BIN="$path"
            break
        fi
    done
fi

if [ -z "$SNORT_BIN" ] || [ ! -x "$SNORT_BIN" ]; then
    echo -e "${RED}‚ùå Error: Snort not found!${NC}"
    echo "   Install Snort3 first: ./installer/install.sh"
    exit 1
fi

echo -e "${GREEN}‚úÖ Snort binary: $SNORT_BIN${NC}"
SNORT_VERSION=$("$SNORT_BIN" --version 2>&1 | grep "Version" | head -1)
echo -e "${GREEN}   $SNORT_VERSION${NC}"
echo ""

# Export for other scripts
export SNORT_BIN
export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"

# -----------------------------------------------------------------------------
# Set PYTHONPATH for imports
# -----------------------------------------------------------------------------
export PYTHONPATH="$SCRIPTS_DIR:$ML_DIR:$PROJECT_DIR:${PYTHONPATH:-}"

# Also add user site-packages for pip-installed packages
if [ -n "$SUDO_USER" ]; then
    USER_HOME=$(getent passwd "$SUDO_USER" 2>/dev/null | cut -d: -f6)
else
    USER_HOME="$HOME"
fi
if [ -d "$USER_HOME/.local/lib/python3.11/site-packages" ]; then
    export PYTHONPATH="$USER_HOME/.local/lib/python3.11/site-packages:$PYTHONPATH"
fi

# -----------------------------------------------------------------------------
# PID file locations
# -----------------------------------------------------------------------------
PID_DIR="/tmp"
ROUTER_PID_FILE="$PID_DIR/astraips_router.pid"
SNORT_PID_FILE="$PID_DIR/astraips_snort.pid"
AI_SERVER_PID_FILE="$PID_DIR/astraips_ai_server.pid"
DEVICE_PROFILER_PID_FILE="$PID_DIR/astraips_device_profiler.pid"
SYSTEM_MONITOR_PID_FILE="$PID_DIR/astraips_system_monitor.pid"
ROUTER_SCANNER_PID_FILE="$PID_DIR/astraips_router_scanner.pid"
DISPLAY_PID_FILE="$PID_DIR/astraips_display.pid"
IPTABLES_ADDED=false

# -----------------------------------------------------------------------------
# Cleanup function
# -----------------------------------------------------------------------------
cleanup() {
    echo ""
    echo -e "${YELLOW}üõë Shutting down AstraIPS...${NC}"
    
    # Remove iptables rules
    if [ "$IPTABLES_ADDED" = true ]; then
        echo "üîì Removing iptables rules..."
        sudo iptables -t nat -D PREROUTING -p tcp --dport 1883 -j REDIRECT --to-port 1889 2>/dev/null || true
        sudo iptables -t nat -D OUTPUT -p tcp --dport 1883 -o lo -j REDIRECT --to-port 1889 2>/dev/null || true
        sudo iptables -D INPUT -p tcp --dport 1889 -j NFQUEUE --queue-num 0 2>/dev/null || true
    fi
    
    # Stop PCAP capture
    PCAP_PID_FILE="$PID_DIR/astraips_pcap.pid"
    if [ -f "$PCAP_PID_FILE" ]; then
        PCAP_PID=$(cat "$PCAP_PID_FILE" 2>/dev/null)
        if [ -n "$PCAP_PID" ] && kill -0 $PCAP_PID 2>/dev/null; then
            echo "üì¶ Stopping PCAP capture..."
            sudo kill $PCAP_PID 2>/dev/null || kill $PCAP_PID 2>/dev/null || true
            sleep 1
        fi
        rm -f "$PCAP_PID_FILE"
    fi
    sudo pkill -f "tcpdump.*1883" 2>/dev/null || true
    
    # Stop alert logger
    ALERT_LOGGER_PID_FILE="$PID_DIR/astraips_alert_logger.pid"
    if [ -f "$ALERT_LOGGER_PID_FILE" ]; then
        ALERT_LOGGER_PID=$(cat "$ALERT_LOGGER_PID_FILE" 2>/dev/null)
        if [ -n "$ALERT_LOGGER_PID" ] && kill -0 $ALERT_LOGGER_PID 2>/dev/null; then
            echo "üìä Stopping Snort Alert Logger..."
            kill $ALERT_LOGGER_PID 2>/dev/null || true
            sleep 1
        fi
        rm -f "$ALERT_LOGGER_PID_FILE"
    fi
    
    # Kill processes
    for pidfile in "$DISPLAY_PID_FILE" "$SYSTEM_MONITOR_PID_FILE" "$ROUTER_SCANNER_PID_FILE" \
                   "$DEVICE_PROFILER_PID_FILE" "$AI_SERVER_PID_FILE" "$ROUTER_PID_FILE" "$SNORT_PID_FILE"; do
        if [ -f "$pidfile" ]; then
            pid=$(cat "$pidfile" 2>/dev/null)
            if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
                kill "$pid" 2>/dev/null || true
            fi
            rm -f "$pidfile"
        fi
    done
    
    # Kill by name as backup
    pkill -f "clean_terminal_display.py" 2>/dev/null || true
    pkill -f "ai_decision_server.py" 2>/dev/null || true
    pkill -f "device_profiler.py" 2>/dev/null || true
    pkill -f "system_monitor.py" 2>/dev/null || true
    pkill -f "mqtt_router.py" 2>/dev/null || true
    pkill -f "router_manager.py" 2>/dev/null || true
    
    sudo systemctl unmask mosquitto 2>/dev/null || true
    
    # Generate session summary and export
    echo ""
    echo -e "${BLUE}üìä Generating session summary...${NC}"
    
    DB_PATH="$SESSION_LOG_DIR/session.db"
    if [ -f "$DB_PATH" ]; then
        # Generate web dashboard
        DASHBOARD_SCRIPT="$PROJECT_DIR/dashboard/generate_dashboard.py"
        if [ -f "$DASHBOARD_SCRIPT" ]; then
            PYTHONPATH="$PYTHONPATH" python3 "$DASHBOARD_SCRIPT" "$DB_PATH" 2>/dev/null && \
                echo -e "${GREEN}   ‚úÖ Web dashboard generated${NC}" || \
                echo -e "${YELLOW}   ‚ö†Ô∏è Dashboard generation failed${NC}"
        fi
        
        # Export to Excel with thesis sheets
        if [ -f "$SCRIPTS_DIR/export_session.py" ]; then
            PYTHONPATH="$PYTHONPATH" python3 "$SCRIPTS_DIR/export_session.py" "$SESSION_LOG_DIR" 2>/dev/null && \
                echo -e "${GREEN}   ‚úÖ Session exported to Excel${NC}" || \
                echo -e "${YELLOW}   ‚ö†Ô∏è Excel export failed (check pandas/openpyxl)${NC}"
        fi
        
        # Show quick stats
        echo ""
        echo -e "${CYAN}üìà Session Statistics:${NC}"
        python3 -c "
import sqlite3
conn = sqlite3.connect('$DB_PATH')
cursor = conn.cursor()

# Get counts
try:
    cursor.execute('SELECT COUNT(*) FROM mqtt_traffic')
    mqtt_count = cursor.fetchone()[0]
    print(f'   MQTT Packets: {mqtt_count}')
except: pass

try:
    cursor.execute('SELECT COUNT(*) FROM snort_alerts')
    alerts = cursor.fetchone()[0]
    print(f'   Snort Alerts: {alerts}')
except: pass

try:
    cursor.execute('SELECT COUNT(*) FROM snort_alerts WHERE ai_flag = \"BLOCK\"')
    blocks = cursor.fetchone()[0]
    print(f'   Blocked:      {blocks}')
except: pass

try:
    cursor.execute('SELECT COUNT(DISTINCT COALESCE(source_mac, source_ip)) FROM mqtt_traffic')
    devices = cursor.fetchone()[0]
    print(f'   Devices:      {devices}')
except: pass

conn.close()
" 2>/dev/null || true
        
        echo ""
        echo -e "${CYAN}üìÅ Session data saved to: $SESSION_LOG_DIR${NC}"
        echo -e "${CYAN}   üìä Dashboard: $SESSION_LOG_DIR/dashboard/session_dashboard.html${NC}"
        echo -e "${CYAN}   üìà Exports:   $SESSION_LOG_DIR/exports/${NC}"
        echo -e "${CYAN}   üì¶ PCAP:      $SESSION_LOG_DIR/pcap/${NC}"
        echo ""
        echo -e "${GREEN}üåê Open dashboard: firefox $SESSION_LOG_DIR/dashboard/session_dashboard.html${NC}"
        
        # List PCAP files
        if [ -d "$SESSION_LOG_DIR/pcap" ] && [ "$(ls -A $SESSION_LOG_DIR/pcap/*.pcap 2>/dev/null)" ]; then
            echo ""
            echo -e "${GREEN}üì¶ PCAP files captured:${NC}"
            ls -lh "$SESSION_LOG_DIR/pcap"/*.pcap 2>/dev/null | awk '{print "   " $9 " (" $5 ")"}'
        fi
    else
        echo -e "${YELLOW}   ‚ö†Ô∏è No session database found${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ Shutdown complete${NC}"
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# -----------------------------------------------------------------------------
# Kill existing processes
# -----------------------------------------------------------------------------
echo -e "${YELLOW}üßπ Cleaning up existing processes...${NC}"
pkill -f "snort_mqtt_enhanced.py" 2>/dev/null || true
pkill -f "mqtt_router.py" 2>/dev/null || true
pkill -f "ai_decision_server.py" 2>/dev/null || true
pkill -f "device_profiler.py" 2>/dev/null || true
pkill -f "system_monitor.py" 2>/dev/null || true
pkill -f "clean_terminal_display.py" 2>/dev/null || true
sudo pkill -9 mosquitto 2>/dev/null || true
sudo systemctl stop mosquitto 2>/dev/null || true
sudo systemctl mask mosquitto 2>/dev/null || true
sudo lsof -ti:1883 2>/dev/null | xargs -r sudo kill -9 2>/dev/null || true
sudo lsof -ti:1889 2>/dev/null | xargs -r sudo kill -9 2>/dev/null || true
sudo lsof -ti:9998 2>/dev/null | xargs -r sudo kill -9 2>/dev/null || true
sleep 2
echo -e "${GREEN}‚úÖ Cleanup complete${NC}"
echo ""

# -----------------------------------------------------------------------------
# STEP 1: Start AI Decision Server
# -----------------------------------------------------------------------------
echo -e "${BLUE}üß† Step 1: Starting AI Decision Server...${NC}"

if [ -f "$ML_DIR/ai_decision_server.py" ]; then
    AI_IP="${INTERFACE_IP:-127.0.0.1}"
    
    (cd "$ML_DIR" && SESSION_LOG_DIR="$SESSION_LOG_DIR" PYTHONPATH="$PYTHONPATH" \
        python3 ai_decision_server.py --ip "$AI_IP" > "$SESSION_LOG_DIR/logs/ai_server.log" 2>&1) &
    AI_SERVER_PID=$!
    echo "$AI_SERVER_PID" > "$AI_SERVER_PID_FILE"
    
    # Wait for AI server to be ready
    echo "   ‚è≥ Waiting for AI server to initialize..."
    for i in {1..15}; do
        if lsof -ti:9998 >/dev/null 2>&1; then
            echo -e "${GREEN}   ‚úÖ AI Decision Server ready (PID: $AI_SERVER_PID)${NC}"
            break
        fi
        sleep 1
    done
else
    echo -e "${YELLOW}   ‚ö†Ô∏è AI Decision Server not found, skipping...${NC}"
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 2: Start Device Profiler
# -----------------------------------------------------------------------------
echo -e "${BLUE}üì° Step 2: Starting Device Profiler...${NC}"

if [ -f "$ML_DIR/device_profiler.py" ]; then
    PROFILER_IP="${INTERFACE_IP:-127.0.0.1}"
    
    sleep 2  # Wait for AI server
    
    SESSION_LOG_DIR="$SESSION_LOG_DIR" PYTHONPATH="$PYTHONPATH" \
        python3 "$ML_DIR/device_profiler.py" --ip "$PROFILER_IP" --host-ip "$PROFILER_IP" \
        > "$SESSION_LOG_DIR/logs/device_profiler.log" 2>&1 &
    DEVICE_PROFILER_PID=$!
    echo "$DEVICE_PROFILER_PID" > "$DEVICE_PROFILER_PID_FILE"
    echo -e "${GREEN}   ‚úÖ Device Profiler started (PID: $DEVICE_PROFILER_PID)${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è Device Profiler not found, skipping...${NC}"
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 3: Start MQTT Router
# -----------------------------------------------------------------------------
echo -e "${BLUE}üì® Step 3: Starting MQTT Router...${NC}"

if [ -f "$SCRIPTS_DIR/mqtt_router.py" ]; then
    # Always run in full IPS mode on port 1889
    MQTT_HOST="0.0.0.0"
    MQTT_PORT="1889"
    
    SESSION_LOG_DIR="$SESSION_LOG_DIR" PYTHONPATH="$PYTHONPATH" PROJECT_DIR="$PROJECT_DIR" \
        python3 "$SCRIPTS_DIR/mqtt_router.py" --host "$MQTT_HOST" --port "$MQTT_PORT" \
        > "$SESSION_LOG_DIR/logs/mqtt_router.log" 2>&1 &
    ROUTER_PID=$!
    echo "$ROUTER_PID" > "$ROUTER_PID_FILE"
    
    # Wait for router to be ready
    echo "   ‚è≥ Waiting for MQTT Router..."
    for i in {1..10}; do
        if netstat -tlnp 2>/dev/null | grep -q ":$MQTT_PORT" || ss -tlnp 2>/dev/null | grep -q ":$MQTT_PORT"; then
            echo -e "${GREEN}   ‚úÖ MQTT Router ready on port $MQTT_PORT (PID: $ROUTER_PID)${NC}"
            break
        fi
        sleep 1
    done
else
    echo -e "${YELLOW}   ‚ö†Ô∏è MQTT Router not found, using mosquitto...${NC}"
    mosquitto -d 2>/dev/null || true
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 4: Setup iptables and Start Snort
# -----------------------------------------------------------------------------
echo -e "${BLUE}ü¶à Step 4: Starting Snort3 IPS...${NC}"

# Setup iptables for inline IPS (always enabled)
echo "   üìã Setting up iptables NFQUEUE rules..."
sudo iptables -t nat -A PREROUTING -p tcp --dport 1883 -j REDIRECT --to-port 1889
sudo iptables -t nat -A OUTPUT -p tcp --dport 1883 -o lo -j REDIRECT --to-port 1889
sudo iptables -I INPUT -p tcp --dport 1889 -j NFQUEUE --queue-num 0
IPTABLES_ADDED=true
echo -e "${GREEN}   ‚úÖ Firewall rules active${NC}"

# Start Snort
CONFIG_FILE="$CONFIG_DIR/mqtt_final.lua"
export SNORT_DAQ_MODE="inline"

echo "   üöÄ Starting Snort in inline IPS mode..."
echo "   üìÑ Alerts will be saved to: $SESSION_LOG_DIR/alert_fast, alert_json, alert_csv"
(
    # Export env vars for Snort and Lua config
    stdbuf -oL -eL sudo env \
        PROJECT_DIR="$PROJECT_DIR" \
        CONFIG_DIR="$CONFIG_DIR" \
        SNORT_DAQ_MODE="inline" \
        SESSION_LOG_DIR="$SESSION_LOG_DIR" \
        "$SNORT_BIN" \
        -c "$CONFIG_FILE" \
        --daq nfq \
        --daq-mode inline \
        --daq-var queue=0 \
        --daq-var fail_open=no \
        -Q \
        -k none \
        -l "$SESSION_LOG_DIR" \
        -A alert_fast \
        -v \
        2>&1 | tee "$SESSION_LOG_DIR/logs/snort.log"
) &
SNORT_PID=$!
echo "$SNORT_PID" > "$SNORT_PID_FILE"

# Wait for Snort to initialize
echo "   ‚è≥ Waiting for Snort to initialize..."
for i in {1..20}; do
    if grep -q "Commencing packet processing" "$SESSION_LOG_DIR/logs/snort.log" 2>/dev/null; then
        echo -e "${GREEN}   ‚úÖ Snort IPS active (PID: $SNORT_PID)${NC}"
        break
    fi
    sleep 1
done
echo ""

# -----------------------------------------------------------------------------
# STEP 4.5: Start PCAP Capture
# -----------------------------------------------------------------------------
echo -e "${BLUE}üì¶ Step 4.5: Starting PCAP Capture...${NC}"

PCAP_DIR="$SESSION_LOG_DIR/pcap"
mkdir -p "$PCAP_DIR"
chmod 777 "$PCAP_DIR" 2>/dev/null || sudo chmod 777 "$PCAP_DIR" 2>/dev/null || true

PCAP_FILE="$PCAP_DIR/mqtt_traffic_$(date +%Y%m%d_%H%M%S).pcap"
PCAP_PID_FILE="$PID_DIR/astraips_pcap.pid"

# Check for tcpdump
if command -v tcpdump >/dev/null 2>&1; then
    # Create file first and set permissions
    sudo touch "$PCAP_FILE" 2>/dev/null || touch "$PCAP_FILE"
    sudo chmod 666 "$PCAP_FILE" 2>/dev/null || chmod 666 "$PCAP_FILE"
    
    # Start tcpdump capture on MQTT ports (1883 and 1889)
    sudo tcpdump -i "$INTERFACE" -w "$PCAP_FILE" "port 1883 or port 1889" \
        > "$SESSION_LOG_DIR/logs/pcap_capture.log" 2>&1 &
    PCAP_PID=$!
    echo "$PCAP_PID" > "$PCAP_PID_FILE"
    
    # Background permission fixer
    (
        while kill -0 $PCAP_PID 2>/dev/null; do
            sleep 10
            sudo chmod 666 "$PCAP_FILE" 2>/dev/null || true
            sudo chmod 666 "$PCAP_DIR"/*.pcap 2>/dev/null || true
            if [ -n "$SUDO_USER" ]; then
                sudo chown "$SUDO_USER:$SUDO_USER" "$PCAP_FILE" 2>/dev/null || true
            fi
        done
    ) &
    
    echo -e "${GREEN}   ‚úÖ PCAP capture started (PID: $PCAP_PID)${NC}"
    echo -e "${CYAN}   üìÑ Output: $PCAP_FILE${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è tcpdump not found - PCAP capture disabled${NC}"
    echo "   Install with: sudo apt install tcpdump"
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 5: Start System Monitor
# -----------------------------------------------------------------------------
echo -e "${BLUE}üìä Step 5: Starting System Monitor...${NC}"

if [ -f "$SCRIPTS_DIR/system_monitor.py" ]; then
    SESSION_LOG_DIR="$SESSION_LOG_DIR" PYTHONPATH="$PYTHONPATH" \
        python3 "$SCRIPTS_DIR/system_monitor.py" --interval 5 \
        > "$SESSION_LOG_DIR/logs/system_monitor.log" 2>&1 &
    SYSTEM_MONITOR_PID=$!
    echo "$SYSTEM_MONITOR_PID" > "$SYSTEM_MONITOR_PID_FILE"
    echo -e "${GREEN}   ‚úÖ System Monitor started (PID: $SYSTEM_MONITOR_PID)${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è System Monitor not found, skipping...${NC}"
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 5.5: Start Snort Alert Logger
# -----------------------------------------------------------------------------
echo -e "${BLUE}üìä Step 5.5: Starting Snort Alert Logger...${NC}"

ALERT_LOGGER_PID_FILE="$PID_DIR/astraips_alert_logger.pid"

if [ -f "$SCRIPTS_DIR/snort_alert_logger.py" ]; then
    SESSION_LOG_DIR="$SESSION_LOG_DIR" PYTHONPATH="$PYTHONPATH" \
        python3 "$SCRIPTS_DIR/snort_alert_logger.py" "$SESSION_LOG_DIR" \
        > "$SESSION_LOG_DIR/logs/snort_alert_logger.log" 2>&1 &
    ALERT_LOGGER_PID=$!
    echo "$ALERT_LOGGER_PID" > "$ALERT_LOGGER_PID_FILE"
    echo -e "${GREEN}   ‚úÖ Snort Alert Logger started (PID: $ALERT_LOGGER_PID)${NC}"
    echo -e "${CYAN}   üìÑ Monitoring: alert_fast, alert_json, alert_csv${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è Snort Alert Logger not found, skipping...${NC}"
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 6: Start Router Scanner (if configured)
# -----------------------------------------------------------------------------
echo -e "${BLUE}üîç Step 6: Checking Router Scanner...${NC}"

ROUTER_CONFIG="$PROJECT_DIR/router-config/router_config.json"
if [ -f "$ROUTER_CONFIG" ]; then
    if python3 -c "import json; c=json.load(open('$ROUTER_CONFIG')); exit(0 if c.get('enabled', False) else 1)" 2>/dev/null; then
        if [ -f "$SCRIPTS_DIR/router_manager.py" ]; then
            SESSION_LOG_DIR="$SESSION_LOG_DIR" PYTHONPATH="$PYTHONPATH" \
                python3 "$SCRIPTS_DIR/router_manager.py" --start \
                > "$SESSION_LOG_DIR/logs/router_scanner.log" 2>&1 &
            ROUTER_SCANNER_PID=$!
            echo "$ROUTER_SCANNER_PID" > "$ROUTER_SCANNER_PID_FILE"
            echo -e "${GREEN}   ‚úÖ Router Scanner started (PID: $ROUTER_SCANNER_PID)${NC}"
        fi
    else
        echo -e "${YELLOW}   ‚ÑπÔ∏è Router scanning disabled in config${NC}"
    fi
else
    echo -e "${YELLOW}   ‚ÑπÔ∏è Router config not found, using local scanning${NC}"
fi
echo ""

# -----------------------------------------------------------------------------
# STEP 7: Start Clean Terminal Display
# -----------------------------------------------------------------------------
echo -e "${BLUE}üñ•Ô∏è Step 7: Starting Terminal Display...${NC}"

if [ -f "$SCRIPTS_DIR/clean_terminal_display.py" ]; then
    PYTHONPATH="$PYTHONPATH" python3 "$SCRIPTS_DIR/clean_terminal_display.py" "$SESSION_LOG_DIR" &
    DISPLAY_PID=$!
    echo "$DISPLAY_PID" > "$DISPLAY_PID_FILE"
    echo -e "${GREEN}   ‚úÖ Terminal Display started${NC}"
fi
echo ""

# -----------------------------------------------------------------------------
# Start background permission fixer
# -----------------------------------------------------------------------------
(
    while true; do
        sleep 30
        # Fix all permissions periodically
        sudo chmod 666 "$SESSION_LOG_DIR"/*.db 2>/dev/null || true
        sudo chmod 666 "$SESSION_LOG_DIR"/*.log 2>/dev/null || true
        sudo chmod 666 "$SESSION_LOG_DIR"/logs/*.log 2>/dev/null || true
        sudo chmod 644 "$SESSION_LOG_DIR"/alert_* 2>/dev/null || true
        sudo chmod 666 "$SESSION_LOG_DIR/pcap"/*.pcap 2>/dev/null || true
        if [ -n "$SUDO_USER" ]; then
            sudo chown -R "$SUDO_USER:$SUDO_USER" "$SESSION_LOG_DIR" 2>/dev/null || true
        fi
    done
) &
PERMISSION_FIXER_PID=$!

# -----------------------------------------------------------------------------
# System Ready
# -----------------------------------------------------------------------------
echo -e "${GREEN}=============================================="
echo "   üõ°Ô∏è  AstraIPS ACTIVE"
echo "==============================================${NC}"
echo ""
echo -e "${CYAN}üì° Interface:     $INTERFACE${NC}"
echo -e "${CYAN}üåê IP Address:    ${INTERFACE_IP:-N/A}${NC}"
echo -e "${CYAN}üîå MQTT External: 1883 ‚Üí IPS ‚Üí 1889${NC}"
echo -e "${CYAN}üìÅ Logs:          $SESSION_LOG_DIR${NC}"
echo -e "${CYAN}üì¶ PCAP:          $SESSION_LOG_DIR/pcap/${NC}"
echo -e "${CYAN}üìä Database:      $SESSION_LOG_DIR/session.db${NC}"
echo ""
echo -e "${YELLOW}üí° Press Ctrl+C to stop the system${NC}"
echo ""

# Keep script running - monitor processes
while true; do
    # Check if Snort is still running
    if [ -f "$SNORT_PID_FILE" ]; then
        SNORT_PID=$(cat "$SNORT_PID_FILE" 2>/dev/null)
        if [ -n "$SNORT_PID" ] && ! kill -0 "$SNORT_PID" 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è Snort process died, check logs${NC}"
            break
        fi
    fi
    sleep 5
done

# Kill permission fixer
kill $PERMISSION_FIXER_PID 2>/dev/null || true

cleanup
